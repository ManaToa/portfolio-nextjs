name: Deploy to VPS (prod)

on:
  push:
    branches: ['prod']

concurrency:
  group: deploy-prod
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Run remote deploy script
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          APP_NAME: ${{ secrets.APP_NAME }}
        run: |
          set -euo pipefail
          PORT="${VPS_PORT:-22}"

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh-keyscan -p "$PORT" -H "$VPS_HOST" >> ~/.ssh/known_hosts

          ssh -p "$PORT" -i ~/.ssh/id_ed25519 -o BatchMode=yes -o StrictHostKeyChecking=yes             "${VPS_USER}@${VPS_HOST}"             "sudo -n /usr/local/bin/nextapp-deploy.sh '${APP_NAME}'"
